(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{ZQH4:function(t,e,a){"use strict";a.r(e),a.d(e,"AddonModGlossaryEditLazyModule",(function(){return Q}));var n=a("L3Fv"),i=a("ekpb"),o=a("tyNb"),d=a("MLi9"),s=a("mrSG"),c=a("3Pt+"),l=a("93ts"),r=a("+mW7"),h=a("hSQQ"),m=a("pHTc"),g=a("GGba"),u=a("9+EE"),f=a("3LXp"),_=a("vuGA"),y=a("bFG1"),p=a("j3ag"),E=a("fjkH"),v=a("4reR"),M=a("gjmY"),b=a("BZ3K"),D=a("7DS8"),A=a("fXoL"),O=a("46ml"),P=a("TEn/"),G=a("ofXK"),I=a("nt/U"),C=a("PgjG"),k=a("hMzs"),w=a("N5Lt"),T=a("M9y5"),F=a("ACYt"),x=a("d0nH"),V=a("sYmb");const j=["editFormEl"];function AddonModGlossaryEditPage_h1_6_Template(t,e){if(1&t&&(A.Ec(0,"h1"),A.zc(1,"core-format-text",4),A.Dc()),2&t){const t=A.Oc();A.lc(1),A.Vc("text",t.glossary.name)("contextInstanceId",t.cmId)("courseId",t.courseId)}}function AddonModGlossaryEditPage_form_9_ion_item_14_ion_select_option_7_Template(t,e){if(1&t&&(A.Ec(0,"ion-select-option",13),A.pd(1),A.Dc()),2&t){const t=e.$implicit;A.Vc("value",t.id),A.lc(1),A.rd(" ",t.name," ")}}const _c1=function(t){return{header:t}};function AddonModGlossaryEditPage_form_9_ion_item_14_Template(t,e){if(1&t){const t=A.Fc();A.Ec(0,"ion-item"),A.Ec(1,"ion-label",6),A.pd(2),A.Pc(3,"translate"),A.Dc(),A.Ec(4,"ion-select",11),A.Mc("ngModelChange",(function AddonModGlossaryEditPage_form_9_ion_item_14_Template_ion_select_ngModelChange_4_listener(e){A.fd(t);return A.Oc(2).data.categories=e})),A.Pc(5,"translate"),A.Pc(6,"translate"),A.nd(7,AddonModGlossaryEditPage_form_9_ion_item_14_ion_select_option_7_Template,2,2,"ion-select-option",12),A.Dc(),A.Dc()}if(2&t){const t=A.Oc(2);A.lc(2),A.rd(" ",A.Qc(3,5,"addon.mod_glossary.categories")," "),A.lc(2),A.Vc("ngModel",t.data.categories)("placeholder",A.Qc(5,7,"addon.mod_glossary.categories"))("interfaceOptions",A.ad(11,_c1,A.Qc(6,9,"addon.mod_glossary.categories"))),A.lc(3),A.Vc("ngForOf",t.categories)}}function AddonModGlossaryEditPage_form_9_ion_item_15_Template(t,e){if(1&t){const t=A.Fc();A.Ec(0,"ion-item"),A.Ec(1,"ion-label",6),A.pd(2),A.Pc(3,"translate"),A.Dc(),A.Ec(4,"ion-textarea",14),A.Mc("ngModelChange",(function AddonModGlossaryEditPage_form_9_ion_item_15_Template_ion_textarea_ngModelChange_4_listener(e){A.fd(t);return A.Oc(2).data.aliases=e})),A.Dc(),A.Dc()}if(2&t){const t=A.Oc(2);A.lc(2),A.rd(" ",A.Qc(3,3,"addon.mod_glossary.aliases")," "),A.lc(2),A.Vc("ngModel",t.data.aliases)("core-auto-rows",t.data.aliases)}}function AddonModGlossaryEditPage_form_9_ng_container_22_Template(t,e){if(1&t){const t=A.Fc();A.Cc(0),A.Ec(1,"ion-item-divider"),A.Ec(2,"ion-label"),A.Ec(3,"h2"),A.pd(4),A.Pc(5,"translate"),A.Dc(),A.Dc(),A.Dc(),A.Ec(6,"ion-item",15),A.Ec(7,"ion-label"),A.pd(8),A.Pc(9,"translate"),A.Dc(),A.Ec(10,"ion-toggle",16),A.Mc("ngModelChange",(function AddonModGlossaryEditPage_form_9_ng_container_22_Template_ion_toggle_ngModelChange_10_listener(e){A.fd(t);return A.Oc(2).data.usedynalink=e})),A.Dc(),A.Dc(),A.Ec(11,"ion-item",15),A.Ec(12,"ion-label"),A.pd(13),A.Pc(14,"translate"),A.Dc(),A.Ec(15,"ion-toggle",17),A.Mc("ngModelChange",(function AddonModGlossaryEditPage_form_9_ng_container_22_Template_ion_toggle_ngModelChange_15_listener(e){A.fd(t);return A.Oc(2).data.casesensitive=e})),A.Dc(),A.Dc(),A.Ec(16,"ion-item",15),A.Ec(17,"ion-label"),A.pd(18),A.Pc(19,"translate"),A.Dc(),A.Ec(20,"ion-toggle",18),A.Mc("ngModelChange",(function AddonModGlossaryEditPage_form_9_ng_container_22_Template_ion_toggle_ngModelChange_20_listener(e){A.fd(t);return A.Oc(2).data.fullmatch=e})),A.Dc(),A.Dc(),A.Bc()}if(2&t){const t=A.Oc(2);A.lc(4),A.qd(A.Qc(5,9,"addon.mod_glossary.linking")),A.lc(4),A.qd(A.Qc(9,11,"addon.mod_glossary.entryusedynalink")),A.lc(2),A.Vc("ngModel",t.data.usedynalink),A.lc(3),A.qd(A.Qc(14,13,"addon.mod_glossary.casesensitive")),A.lc(2),A.Vc("disabled",!t.data.usedynalink)("ngModel",t.data.casesensitive),A.lc(3),A.qd(A.Qc(19,15,"addon.mod_glossary.fullmatch")),A.lc(2),A.Vc("disabled",!t.data.usedynalink)("ngModel",t.data.fullmatch)}}function AddonModGlossaryEditPage_form_9_Template(t,e){if(1&t){const t=A.Fc();A.Ec(0,"form",null,5),A.Ec(2,"ion-item"),A.Ec(3,"ion-label",6),A.pd(4),A.Pc(5,"translate"),A.Dc(),A.Ec(6,"ion-input",7),A.Mc("ngModelChange",(function AddonModGlossaryEditPage_form_9_Template_ion_input_ngModelChange_6_listener(e){A.fd(t);return A.Oc().data.concept=e})),A.Pc(7,"translate"),A.Dc(),A.Dc(),A.Ec(8,"ion-item"),A.Ec(9,"ion-label",6),A.pd(10),A.Pc(11,"translate"),A.Dc(),A.Ec(12,"core-rich-text-editor",8),A.Mc("contentChanged",(function AddonModGlossaryEditPage_form_9_Template_core_rich_text_editor_contentChanged_12_listener(e){A.fd(t);return A.Oc().onDefinitionChange(e)})),A.Pc(13,"translate"),A.Dc(),A.Dc(),A.nd(14,AddonModGlossaryEditPage_form_9_ion_item_14_Template,8,13,"ion-item",2),A.nd(15,AddonModGlossaryEditPage_form_9_ion_item_15_Template,5,5,"ion-item",2),A.Ec(16,"ion-item-divider"),A.Ec(17,"ion-label"),A.Ec(18,"h2"),A.pd(19),A.Pc(20,"translate"),A.Dc(),A.Dc(),A.Dc(),A.zc(21,"core-attachments",9),A.nd(22,AddonModGlossaryEditPage_form_9_ng_container_22_Template,21,17,"ng-container",2),A.Ec(23,"ion-button",10),A.Mc("click",(function AddonModGlossaryEditPage_form_9_Template_ion_button_click_23_listener(){A.fd(t);return A.Oc().save()})),A.pd(24),A.Pc(25,"translate"),A.Dc(),A.Dc()}if(2&t){const t=A.Oc();A.lc(4),A.qd(A.Qc(5,22,"addon.mod_glossary.concept")),A.lc(2),A.Vc("placeholder",A.Qc(7,24,"addon.mod_glossary.concept"))("ngModel",t.data.concept),A.lc(4),A.qd(A.Qc(11,26,"addon.mod_glossary.definition")),A.lc(2),A.Vc("control",t.definitionControl)("placeholder",A.Qc(13,28,"addon.mod_glossary.definition"))("component",t.component)("componentId",t.cmId)("autoSave",!0)("contextInstanceId",t.cmId)("draftExtraParams",t.editorExtraParams),A.lc(2),A.Vc("ngIf",t.categories.length>0),A.lc(1),A.Vc("ngIf",t.showAliases),A.lc(4),A.qd(A.Qc(20,30,"addon.mod_glossary.attachment")),A.lc(2),A.Vc("files",t.data.attachments)("component",t.component)("componentId",t.glossary.coursemodule)("allowOffline",!0)("courseId",t.courseId),A.lc(1),A.Vc("ngIf",t.glossary.usedynalink),A.lc(1),A.Vc("disabled",!t.data.concept||!t.data.definition),A.lc(1),A.rd(" ",A.Qc(25,32,"core.save")," ")}}let L=(()=>{class AddonModGlossaryEditPage{constructor(t,e){this.route=t,this.splitView=e,this.component=M.b.COMPONENT,this.loaded=!1,this.definitionControl=new c.g,this.categories=[],this.showAliases=!0,this.editorExtraParams={},this.data={concept:"",definition:"",timecreated:0,attachments:[],categories:[],aliases:"",usedynalink:!1,casesensitive:!1,fullmatch:!1},this.isDestroyed=!1,this.saved=!1}ngOnInit(){return Object(s.a)(this,void 0,void 0,(function*(){try{const t=m.a.getRouteParam("entrySlug");if(this.cmId=m.a.getRequiredRouteNumberParam("cmId"),this.courseId=m.a.getRequiredRouteNumberParam("courseId"),null==t?void 0:t.startsWith("new-")){const e=Number(t.slice(4));this.editorExtraParams.timecreated=e,this.handler=new edit_AddonModGlossaryOfflineFormHandler(this,e)}else if(t){const{entry:e}=yield M.a.getEntry(Number(t));this.editorExtraParams.timecreated=e.timecreated,this.handler=new edit_AddonModGlossaryOnlineFormHandler(this,e)}else this.handler=new edit_AddonModGlossaryNewFormHandler(this)}catch(t){return f.a.showErrorModal(t),this.goBack(),void 0}this.fetchData()}))}fetchData(){return Object(s.a)(this,void 0,void 0,(function*(){try{this.glossary=yield M.a.getGlossary(this.courseId,this.cmId),yield this.handler.loadData(this.glossary),this.loaded=!0}catch(t){f.a.showErrorModalDefault(t,"addon.mod_glossary.errorloadingglossary",!0),this.goBack()}}))}resetForm(){this.originalData=void 0,this.data.concept="",this.data.definition="",this.data.timecreated=0,this.data.categories=[],this.data.aliases="",this.data.usedynalink=!1,this.data.casesensitive=!1,this.data.fullmatch=!1,this.data.attachments.length=0,this.definitionControl.setValue("")}onDefinitionChange(t){this.data.definition=t}canLeave(){return Object(s.a)(this,void 0,void 0,(function*(){return this.saved||(this.hasDataChanged()&&(yield f.a.showConfirm(p.I.instant("core.confirmcanceledit"))),h.a.clearTmpFiles(this.data.attachments),v.a.triggerFormCancelledEvent(this.formElement,u.c.getCurrentSiteId())),!0}))}save(){return Object(s.a)(this,void 0,void 0,(function*(){if(!this.data.concept||!this.data.definition)return f.a.showErrorModal("addon.mod_glossary.fillfields",!0),void 0;if(!this.glossary)return;const t=yield f.a.showModalLoading("core.sending",!0);try{const e=yield this.handler.save(this.glossary);this.saved=!0,v.a.triggerFormSubmittedEvent(this.formElement,e,u.c.getCurrentSiteId()),this.goBack()}catch(t){f.a.showErrorModalDefault(t,"addon.mod_glossary.cannoteditentry",!0)}finally{t.dismiss()}}))}hasDataChanged(){return this.originalData&&void 0!==this.originalData.concept?this.originalData.definition!=this.data.definition||this.originalData.concept!=this.data.concept||h.a.areFileListDifferent(this.data.attachments,this.originalData.attachments):!!(this.data.definition||this.data.concept||this.data.attachments.length>0)}goBack(){var t;(null===(t=this.splitView)||void 0===t?void 0:t.outletActivated)?m.a.navigate("../../"):m.a.back()}}return AddonModGlossaryEditPage.ɵfac=function AddonModGlossaryEditPage_Factory(t){return new(t||AddonModGlossaryEditPage)(A.yc(o.a),A.yc(O.a,8))},AddonModGlossaryEditPage.ɵcmp=A.sc({type:AddonModGlossaryEditPage,selectors:[["page-addon-mod-glossary-edit"]],viewQuery:function AddonModGlossaryEditPage_Query(t,e){var a;(1&t&&A.ud(j,!0),2&t)&&(A.dd(a=A.Nc())&&(e.formElement=a.first))},decls:10,vars:6,consts:[["slot","start"],[3,"text"],[4,"ngIf"],[3,"hideUntil"],["contextLevel","module",3,"text","contextInstanceId","courseId"],["editFormEl",""],["position","stacked"],["type","text","name","concept",3,"placeholder","ngModel","ngModelChange"],["name","addon_mod_glossary_edit","contextLevel","module","elementId","definition_editor",3,"control","placeholder","component","componentId","autoSave","contextInstanceId","draftExtraParams","contentChanged"],[3,"files","component","componentId","allowOffline","courseId"],["expand","block",1,"ion-margin",3,"disabled","click"],["multiple","true","interface","action-sheet","name","categories",3,"ngModel","placeholder","interfaceOptions","ngModelChange"],[3,"value",4,"ngFor","ngForOf"],[3,"value"],["rows","1","name","aliases",3,"ngModel","core-auto-rows","ngModelChange"],[1,"ion-text-wrap"],["name","usedynalink",3,"ngModel","ngModelChange"],["name","casesensitive",3,"disabled","ngModel","ngModelChange"],["name","fullmatch",3,"disabled","ngModel","ngModelChange"]],template:function AddonModGlossaryEditPage_Template(t,e){1&t&&(A.Ec(0,"ion-header"),A.Ec(1,"ion-toolbar"),A.Ec(2,"ion-buttons",0),A.zc(3,"ion-back-button",1),A.Pc(4,"translate"),A.Dc(),A.Ec(5,"ion-title"),A.nd(6,AddonModGlossaryEditPage_h1_6_Template,2,3,"h1",2),A.Dc(),A.Dc(),A.Dc(),A.Ec(7,"ion-content"),A.Ec(8,"core-loading",3),A.nd(9,AddonModGlossaryEditPage_form_9_Template,26,34,"form",2),A.Dc(),A.Dc()),2&t&&(A.lc(3),A.Vc("text",A.Qc(4,4,"core.back")),A.lc(3),A.Vc("ngIf",e.glossary),A.lc(2),A.Vc("hideUntil",e.loaded),A.lc(1),A.Vc("ngIf",e.glossary))},directives:[P.C,P.Ab,P.m,P.h,P.i,P.yb,G.t,I.a,P.v,C.a,k.a,c.H,c.s,c.t,P.I,P.O,P.H,P.Pb,c.r,c.u,w.a,P.J,T.a,F.a,P.l,P.lb,P.Ob,G.s,P.mb,P.wb,x.a,P.zb,P.d],pipes:[V.d],encapsulation:2}),AddonModGlossaryEditPage})();class edit_AddonModGlossaryFormHandler{constructor(t){this.page=t}loadCategories(t){return Object(s.a)(this,void 0,void 0,(function*(){this.page.categories=yield M.a.getAllCategories(t.id,{cmId:this.page.cmId})}))}uploadAttachments(t){return Object(s.a)(this,void 0,void 0,(function*(){const e=this.page.data;return yield h.a.uploadOrReuploadFiles(e.attachments,M.b.COMPONENT,t.id)}))}storeAttachments(t,e){return Object(s.a)(this,void 0,void 0,(function*(){const a=this.page.data;return yield b.a.storeFiles(t.id,a.concept,e,a.attachments)}))}checkDuplicates(t){return Object(s.a)(this,void 0,void 0,(function*(){if(t.allowduplicatedentries)return;const e=this.page.data;if(yield M.a.isConceptUsed(t.id,e.concept,{timeCreated:e.timecreated,cmId:this.page.cmId}))throw new l.a(p.I.instant("addon.mod_glossary.errconceptalreadyexists"))}))}getSaveOptions(t){const e=this.page.data,a={};return this.page.showAliases&&(a.aliases=e.aliases),this.page.categories.length>0&&(a.categories=e.categories.join(",")),t.usedynalink&&(a.usedynalink=e.usedynalink?1:0,e.usedynalink&&(a.casesensitive=e.casesensitive?1:0,a.fullmatch=e.fullmatch?1:0)),a}}class edit_AddonModGlossaryOfflineFormHandler extends edit_AddonModGlossaryFormHandler{constructor(t,e){super(t),this.timecreated=e}loadData(t){var e,a,n,i;return Object(s.a)(this,void 0,void 0,(function*(){const o=this.page.data,d=yield D.a.getOfflineEntry(t.id,this.timecreated);o.concept=d.concept||"",o.definition=d.definition||"",o.timecreated=d.timecreated,d.options&&(o.categories=(null!==(a=null===(e=d.options.categories)||void 0===e?void 0:e.split(","))&&void 0!==a?a:[]).map((t=>Number(t))),o.aliases=null!==(n=d.options.aliases)&&void 0!==n?n:"",o.usedynalink=!!d.options.usedynalink,o.usedynalink&&(o.casesensitive=!!d.options.casesensitive,o.fullmatch=!!d.options.fullmatch)),(null===(i=d.attachments)||void 0===i?void 0:i.offline)&&(o.attachments=yield b.a.getStoredFiles(t.id,d.concept,d.timecreated)),this.page.originalData={concept:o.concept,definition:o.definition,attachments:o.attachments.slice(),timecreated:o.timecreated,categories:o.categories.slice(),aliases:o.aliases,usedynalink:o.usedynalink,casesensitive:o.casesensitive,fullmatch:o.fullmatch},this.page.definitionControl.setValue(o.definition),yield this.loadCategories(t)}))}save(t){return Object(s.a)(this,void 0,void 0,(function*(){const e=this.page.data,a=this.page.data;let n;return a.attachments.length&&(n=yield this.storeAttachments(t,a.timecreated)),e.concept!==a.concept&&(yield b.a.deleteStoredFiles(t.id,e.concept,a.timecreated)),yield this.updateOfflineEntry(t,n),h.a.clearTmpFiles(a.attachments),!1}))}updateOfflineEntry(t,e){return Object(s.a)(this,void 0,void 0,(function*(){const a=this.page.originalData,n=this.page.data,i=this.getSaveOptions(t),o=_.a.formatHtmlLines(n.definition);a&&(yield this.checkDuplicates(t),yield D.a.updateOfflineEntry({glossaryid:t.id,courseid:this.page.courseId,concept:a.concept,timecreated:a.timecreated},n.concept,o,i,e))}))}}class edit_AddonModGlossaryNewFormHandler extends edit_AddonModGlossaryFormHandler{loadData(t){return Object(s.a)(this,void 0,void 0,(function*(){yield this.loadCategories(t)}))}save(t){return Object(s.a)(this,void 0,void 0,(function*(){const e=this.page.data,a=Date.now();let n,i;if(e.attachments.length)try{n=yield this.uploadAttachments(t)}catch(e){if(y.a.isWebServiceError(e))throw e;i=yield this.storeAttachments(t,a)}const o=i?yield this.createOfflineEntry(t,a,i):yield this.createOnlineEntry(t,a,n,!e.attachments.length);return h.a.clearTmpFiles(e.attachments),o&&(b.a.deleteStoredFiles(t.id,e.concept,a),E.b.trigger(E.b.ACTIVITY_DATA_SENT,{module:"glossary"})),!!o}))}createOfflineEntry(t,e,a){return Object(s.a)(this,void 0,void 0,(function*(){const n=this.page.data,i=this.getSaveOptions(t),o=_.a.formatHtmlLines(n.definition);yield this.checkDuplicates(t),yield D.a.addOfflineEntry(t.id,n.concept,o,this.page.courseId,e,i,a,void 0,void 0)}))}createOnlineEntry(t,e,a,n){return Object(s.a)(this,void 0,void 0,(function*(){const i=this.page.data,o=this.getSaveOptions(t),d=_.a.formatHtmlLines(i.definition);return yield M.a.addEntry(t.id,i.concept,d,this.page.courseId,o,a,{timeCreated:e,allowOffline:n,checkDuplicates:!t.allowduplicatedentries})}))}}class edit_AddonModGlossaryOnlineFormHandler extends edit_AddonModGlossaryFormHandler{constructor(t,e){super(t),this.entry=e}loadData(){return Object(s.a)(this,void 0,void 0,(function*(){const t=this.page.data;t.concept=this.entry.concept,t.definition=this.entry.definition||"",t.timecreated=this.entry.timecreated,t.usedynalink=this.entry.usedynalink,t.usedynalink&&(t.casesensitive=this.entry.casesensitive,t.fullmatch=this.entry.fullmatch),this.entry.attachments&&(t.attachments=this.entry.attachments),this.page.originalData={concept:t.concept,definition:t.definition,attachments:t.attachments.slice(),timecreated:t.timecreated,categories:t.categories.slice(),aliases:t.aliases,usedynalink:t.usedynalink,casesensitive:t.casesensitive,fullmatch:t.fullmatch},this.page.definitionControl.setValue(t.definition),this.page.showAliases=!1}))}save(t){return Object(s.a)(this,void 0,void 0,(function*(){if(!g.a.isOnline())throw new r.a;const e=this.page.data,a=this.getSaveOptions(t),n=_.a.formatHtmlLines(e.definition);let i;return e.attachments.length&&(i=yield this.uploadAttachments(t)),yield M.a.updateEntry(t.id,this.entry.id,e.concept,n,a,i),h.a.clearTmpFiles(e.attachments),E.b.trigger(E.b.ACTIVITY_DATA_SENT,{module:"glossary"}),!0}))}}const H=[{path:"",component:L,canDeactivate:[d.a]}];let Q=(()=>{class AddonModGlossaryEditLazyModule{}return AddonModGlossaryEditLazyModule.ɵmod=A.wc({type:AddonModGlossaryEditLazyModule}),AddonModGlossaryEditLazyModule.ɵinj=A.vc({factory:function AddonModGlossaryEditLazyModule_Factory(t){return new(t||AddonModGlossaryEditLazyModule)},imports:[[o.m.forChild(H),n.a,i.a]]}),AddonModGlossaryEditLazyModule})();void(("undefined"==typeof ngJitMode||ngJitMode)&&A.kd(Q,{declarations:[L],imports:[o.m,n.a,i.a]}))}}]);